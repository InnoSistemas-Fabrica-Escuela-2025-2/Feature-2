name: CI/CD - Full Stack Pipeline

on: 
  push:
    branches: [main, integracios2_docker]
    paths: 
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/ci-cd.yml'
  pull_request:
    branches: [main]
    paths: 
      - 'frontend/**'
      - 'backend/**'
  workflow_dispatch:

jobs:
  # Backend Tests
  test-backend:
    name: Test Backend Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [authenticator, gateway, innosistemas]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          
      - name: Run tests for ${{ matrix.service }}
        working-directory: backend/${{ matrix.service }}
        env:
          SPRING_PROFILES_ACTIVE: test
          SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb
          SPRING_DATASOURCE_USERNAME: sa
          SPRING_DATASOURCE_PASSWORD: ""
        run: ./mvnw test

  # Frontend Tests & Build
  test-build-frontend:
    name: Test & Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run tests
        working-directory: ./frontend
        run: npm test
        
      - name: Build project
        working-directory: ./frontend
        env:
          VITE_API_GATEWAY_URL: ${{ secrets.VITE_API_GATEWAY_URL || 'http://localhost:8080' }}
        run: npm run build

  # Docker Build & Validation
  docker-build:
    name: Build & Test Docker Images
    needs: [test-backend]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        service: [authenticator, gateway, innosistemas]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build ${{ matrix.service }} Docker image
        working-directory: backend/${{ matrix.service }}
        run: |
          docker build -t innosistemas-${{ matrix.service }}:latest .
          
      - name: Test ${{ matrix.service }} health check
        run: |
          PORT=${{ matrix.service == 'gateway' && '8080' || matrix.service == 'authenticator' && '8081' || '8082' }}
          docker run -d --name test-${{ matrix.service }} \
            -e PORT=$PORT \
            -e SPRING_PROFILES_ACTIVE=test \
            innosistemas-${{ matrix.service }}:latest
          
          echo "Waiting for service to start..."
          sleep 45
          
          echo "Checking logs..."
          docker logs test-${{ matrix.service }}
          
          echo "Cleaning up..."
          docker stop test-${{ matrix.service }} || true
          docker rm test-${{ matrix.service }} || true

  # Deploy Frontend to Vercel
  deploy-frontend:
    name: Deploy Frontend to Vercel
    needs: [test-build-frontend, docker-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
        
      - name: Deploy to Vercel
        run: vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VITE_API_GATEWAY_URL: ${{ secrets.VITE_API_GATEWAY_URL }}
  
  # Validate Render Configuration
  validate-render:
    name: Validate Render Deployment Config
    needs: [docker-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check render.yaml exists
        run: |
          if [ ! -f render.yaml ]; then
            echo "‚ùå render.yaml not found!"
            exit 1
          fi
          echo "‚úÖ render.yaml found"
          
      - name: Validate Dockerfiles
        run: |
          services=(authenticator gateway innosistemas)
          for service in "${services[@]}"; do
            if [ ! -f "backend/${service}/Dockerfile" ]; then
              echo "‚ùå Dockerfile not found for ${service}"
              exit 1
            fi
            echo "‚úÖ Dockerfile found for ${service}"
          done
          
      - name: Check docker-compose.yml
        run: |
          if [ ! -f backend/docker-compose.yml ]; then
            echo "‚ùå docker-compose.yml not found!"
            exit 1
          fi
          echo "‚úÖ docker-compose.yml found"
      
      - name: Deployment Ready
        run: |
          echo "üöÄ All checks passed! Ready for Render deployment."
          echo "Backend services will auto-deploy via Render Blueprint (render.yaml)"
          echo "Frontend deployed to Vercel successfully"

